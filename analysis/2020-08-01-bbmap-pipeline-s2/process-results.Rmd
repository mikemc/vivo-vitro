
```{r}
library(tidyverse)
library(here)
library(fs)

out_path <- here("analysis/2020-08-01-bbmap-pipeline-s2/output")
```

Map from species to genome accession
```{r}
strains <- here("strain-info/strains-uniprot.csv") %>%
  read_csv(col_types = "cccccccicc") %>%
  glimpse %>%
  select(strain_type, species, strain, phylum,
    accession = uniprot_assembly_accession)
```
DNA sample data (for the map from well to DNA sample id)
```{r}
dna_sam <- here("sample-data", "dna-sample-data.Rds") %>% readRDS
```

Note: The S2 results are labeled by well rather than DNA sample id.

## Host reads

Load the BBSplit refstats results from mapping against the host,
```{r}
host <- tibble(fn = dir_ls(out_path, 
    regexp = "[A-H][0-9]{2}-host-refstats.tsv")) %>%
  mutate(
    well = path_file(fn) %>% str_extract("[A-H][0-9]{2}(?=-host-refstats)"),
    data = map(fn, read_tsv, col_types = "cddddiiii")
  ) %>%
  select(-fn) %>%
  unnest(data) %>%
  janitor::clean_names() %>%
  rename(name = number_name) %>%
  glimpse
```

```{r}
host %>% pull(unambiguous_reads) %>% summary
host %>% pull(ambiguous_reads) %>% summary
```

## Bacterial reads

First, load the BBSplit refstats results,
```{r}
res <- tibble(fn = dir_ls(out_path, regexp = "[A-H][0-9]{2}-refstats.tsv")) %>%
  mutate(
    well = path_file(fn) %>% str_extract("[A-H][0-9]{2}(?=-refstats)"),
    data = map(fn, read_tsv, col_types = "cddddiiii")
  ) %>%
  select(-fn) %>%
  unnest(data) %>%
  janitor::clean_names() %>%
  rename(name = number_name) %>%
  glimpse
```
Join the strain info,
```{r}
res0 <- res %>%
  mutate(
    accession = str_extract(name, "GCA_[0-9]+\\.[0-9]")
    ) %>%
  left_join(strains, by = "accession") %>%
  arrange(well, species)
```
Add the host mapping results,
```{r}
res1 <- bind_rows(
  res0, 
  host %>% mutate(species = "Mus musculus")
  )
```

Next, set the sample names to have the form `S2_{dna_sample_id}`
```{r}
res2 <- res1 %>%
  # convert well format from A01 to A1
  mutate(well = str_replace(well, "(?<=[A-H])0", "")) %>%
  left_join(dna_sam %>% select(well, dna_sample_id), by = "well") %>%
  mutate(sample_id = str_c("S2_", dna_sample_id)) %>%
  arrange(sample_id, species)
```

Finally, create and save an abundance matrix from the unambiguously-mapped read
counts,
```{r}
mat <- res2 %>%
  select(sample_id, species, unambiguous_reads) %>%
  pivot_wider(names_from = species, values_from = unambiguous_reads,
    names_sort = TRUE, values_fill = 0) %>%
  column_to_rownames("sample_id") %>%
  as("matrix")
```

```{r}
saveRDS(mat, here("results", "s2", "count-matrix.Rds"))
```

