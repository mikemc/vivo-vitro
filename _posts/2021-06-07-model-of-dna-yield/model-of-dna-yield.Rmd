---
title: "Exploring DNA yields in the 2019 experiment"
description: |
author:
  - name: Michael R. McLaren
    affiliation: North Carolina State University
categories:
  - DNA yield
draft: false
output:
  distill::distill_article:
    self_contained: false
    toc: true
    toc_float: true
    dev: svg
creative_commons: CC BY
# bibliography: ../../_references.bib
---

```{r, include = FALSE}
# knitr chunk options
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  cache = TRUE,
  autodep = TRUE,
  cache.comments = FALSE
)
```

```{r}
library(tidyverse)
library(here)

library(cowplot)
library(patchwork)
theme_set(theme_cowplot())

library(ggbeeswarm)

library(rstan)
library(brms)

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

Load the DNA sample data and compute the concentration of input material for each aliquot in terms of pellets per aliquot, accounting for different homogenization volumes. 
Here I approximate the homogenization volume by the amount of PBS added; this is likely an ok approximation for getting relative concentration differences within sample types, which is the main purpose here.

```{r}
sam <- here("output", "sample-data", "dna-sample-data.Rds") %>%
  readRDS %>%
  mutate(
    pellets_per_aliquot = number_of_pellets / volume_pbs * volume_per_aliquot
  ) %>%
  glimpse
```


## Compare DNA concentration estimates

```{r}
sam %>%
  mutate(across(starts_with("dna_conc"), ~log10(. + 1e-2))) %>%
  ggplot(aes(x = .panel_x, y = .panel_y, 
      color = specimen_type, fill = specimen_type)) +
  # geom_point(alpha = 0.5, shape = 16, size = 1) + 
  geom_point(alpha = 0.5) + 
  ggforce::geom_autodensity(alpha = 0.5) +
  ggforce::facet_matrix(vars(starts_with("dna_conc")), layer.diag = 2) +
  theme_minimal_grid()
```

TBD: what is the detection limit for the concentration meausurements?


```{r}
sam %>%
  mutate(across(starts_with("dna_conc"), ~log10(. + 1e-2))) %>%
  pivot_longer(starts_with("dna_conc_")) %>%
  ggplot(aes(x = dna_conc, y = value, 
      color = specimen_type, fill = specimen_type)) +
  geom_abline() +
  stat_smooth(aes(group = 0), method = "lm") +
  geom_point(alpha = 0.5) + 
  facet_wrap(~name) +
  coord_fixed() +
  theme_minimal_grid()
```

What does this imply about where certain measurements might be over/under-estimating changes in yield?


## First pass

Assume our measurements are correct; consider yield vs expected biomass as determined by the number of pellets that were pooled and the number of aliquots they were split into.

```{r}
sam %>%
  count(specimen_type, number_of_aliquots, number_of_pellets, pellets_per_aliquot)
```

HERE - is it correct to normalize by number of aliquots when 2 vs 4? Or was the same volume of PBS added, and same volume aliquoted, in either case?

```{r}
sam %>%
  filter(specimen_type != "Fecal") %>%
  ggplot(aes(pellets_per_aliquot, dna_conc,
      color = specimen_type, shape = extraction_batch)) +
  # geom_abline(color = "grey") +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  scale_shape_manual(values = c(1, 3)) +
  theme_minimal_grid() +
  coord_fixed() +
  facet_wrap(~extraction_protocol, labeller = "label_both")
#> +
#>   stat_smooth(aes(group = specimen_type:extraction_protocol), method = "lm")
```

Note the larger E2 yields especially in the second batch.

It is hard to draw very firm conclusions, in part due to potential batch effects.

Note: The second batch went through a further freeze-thaw cycle (all sample types). 
This could potentially increase yield in this batch for a given biomass, though unclear.


How do these compare to the fecal samples?

```{r}
sam %>%
  ggplot(aes(pellets_per_aliquot, dna_conc,
      color = specimen_type, shape = extraction_batch)) +
  # geom_abline(color = "grey") +
  # geom_point() +
  geom_quasirandom(groupOnX = TRUE, width = 0.1) +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_brewer(type = "qual", palette = 2) +
  scale_shape_manual(values = c(1, 3)) +
  theme_minimal_grid() +
  coord_fixed() +
  facet_wrap(~extraction_protocol, labeller = "label_both")
#> +
#>   stat_smooth(aes(group = specimen_type:extraction_protocol), method = "lm")
```

The difference between the extraction protocols on the inoculum yields is even more is striking when we add the fecal measurements in.
For E2, it looks like 2 pelles per aliquot is sufficient to to reach fecal yields; yet for E1 the inoculum yields remain 10-30X lower.


TODO: Confirm this result based on the other 2 DNA concentration measurements.


This result seems like evidence that something very strange is happening!


For E2, the relationship between PPA and measurec concentration from the batch-1 to batch-2 inoc and T.mob samples looks roughly proportional even across the two batches (though hard to make much of the single high-PPA tmob sample).
For E1, it looks somewhat less than proportional for the inoc samples, but greater than proportional for the high PPA T.mob sample.
Might be worth looking at the other DNA concentration measurements, which might give some evidence as to whether our concentration measurements themselves are linear at the low end.

Note, a statistical model could do better by letting us used the fact that samples are grouped into specimens.



```{r}
sam %>%
  ggplot(aes(pellets_per_aliquot, dna_conc,
      color = specimen_type, shape = extraction_batch)) +
  geom_text(aes(label = specimen_id), 
    position = position_quasirandom(groupOnX = TRUE, width = 0.2)) +
  scale_x_log10() +
  scale_y_log10() +
  scale_shape_manual(values = c(1, 3)) +
  theme_minimal_grid() +
  coord_fixed() +
  facet_wrap(~extraction_protocol, labeller = "label_both")
```


What can we learn from the T. mobilis samples?
Here the story seems consistent between the two extraction protocols; we see that a PPA of 5 in Batch 2 give yield similar to and even about 2X greater than the median Batch-2 fecal sample.

```{r}
x <- sam %>%
  with_groups(
    c(extraction_protocol, extraction_batch, specimen_type),
    summarize, across(starts_with("dna_conc"), median, na.rm = TRUE)
  ) %>%
  rename(protocol = extraction_protocol, batch = extraction_batch)
```

```{r}
x %>%
  pivot_longer(starts_with("dna_conc")) %>%
  pivot_wider(names_from = specimen_type) %>%
  print %>%
  mutate(across(c("Fecal", "Inoculum", "T. mobilis"), ~ . / Fecal))
```

The T. mobilis sample with 5 PPA has

- Protocol 1: 0.7X to 1.6X greater concentration than the fecal samples by protocol 1
- Protocol 2: 1.7X to 3.3X greater concentration


Is there something about the first protocol that makes it poor at extracting the inoculum?

Based on extraction protocol 2 and ignoring batch effects, we'd judge that increasing PPA from 0.25 to ~3 would make the inoculum samples comparable to the fecal samples.
This same result is given by both the inoc and tmob samples.
This amounts to a $3/0.25 = 12$ fold increase in input biomass.

See below for a more thorough approach.

Notice the reverse relationship in yield in the fecal samples between the two batches and protocols,

```{r}
sam %>%
  filter(specimen_type == "Fecal") %>%
  ggplot(aes(extraction_protocol, dna_conc, color = extraction_batch)) +
  geom_boxplot() +
  # geom_text(aes(label = specimen_id), position = position_dodge()) +
  scale_y_log10() +
  scale_shape_manual(values = c(1, 3)) +
  theme_minimal_grid()
```

NOTE: The below is probably not quite right in terms of the new def of pellets per aliquot.
(not sure if it was correct originally either)

Compute the factor increase in input that would give fecal-like DNA yield assuming idealized extraction and DNA quantification, as implied by distinct protocol X batch X (inoc or T. mob).
Collapse values for fecal samples of the given (extraction protocol X batch X yield measurement) using the geometric median.

```{r}
y <- sam %>%
  pivot_longer(starts_with("dna_conc")) %>%
  filter(!is.na(value))
med_fecal <- y %>%
  filter(specimen_type == "Fecal") %>%
  with_groups(
    c(extraction_protocol, extraction_batch, name),
    summarize, across(value, ~exp(median(log(.), na.rm = TRUE)))
  )
y1 <- y %>%
  filter(specimen_type != "Fecal") %>%
  left_join(med_fecal, 
    by = c("extraction_protocol", "extraction_batch", "name"),
    suffix = c("", ".fecal")
  ) %>%
  mutate(
    mult = value.fecal / value,
    mult_adj = (value.fecal / 0.25) / (value / pellets_per_aliquot),
  )
```

```{r, fig.width = 7, fig.height = 7}
y1 %>%
  ggplot(aes(extraction_batch, mult_adj, 
      color = specimen_type, shape = specimen_type)) +
  geom_quasirandom() +
  scale_y_log10(breaks = 10^seq(-2, 4)) +
  scale_shape_manual(values = c(1, 16)) +
  facet_grid(name~extraction_protocol, labeller = "label_both") +
  expand_limits(y = 1) +
  theme_minimal_hgrid() +
  theme(legend.position = "bottom") +
  scale_color_brewer(type = "qual", palette = 1)
```

TODO: investigate why there are NAs still.

Can see that extraction protocol 2 consistent results indicate a multiplier of around 10X is needed, while  extraction protocol 1 indicates a factor of 100X to 300X+ is needed, depending on which concentration measurements we use.
Splitting the difference and aiming for 30X increase in input biomass per aliquot is a reasonable compromise, but shooting for 100X is a safer bet if we want to ensure that the dilution window overlaps the fecal composition in the original experiment.


### new 

```{r}
y <- sam %>%
  pivot_longer(starts_with("dna_conc")) %>%
  filter(!is.na(value)) %>%
  mutate(
    value = value / pellets_per_aliquot
  ) %>%
  with_groups(
    c(specimen_type, extraction_protocol, extraction_batch, name),
    # geometric median
    summarize, across(value, ~exp(median(log(.))))
  ) %>%
  pivot_wider(names_from = specimen_type) %>%
  mutate(across(c(Inoculum, `T. mobilis`), ~ Fecal / .)) %>%
  pivot_longer(c(Inoculum, `T. mobilis`), names_to = "specimen_type")
```

```{r, fig.width = 7, fig.height = 7}
y %>%
  ggplot(aes(extraction_batch, value, color = specimen_type)) +
  geom_quasirandom() +
  scale_y_log10(breaks = 10^seq(-2, 4)) +
  facet_grid(name~extraction_protocol, labeller = "label_both") +
  expand_limits(y = 1) +
  theme_minimal_hgrid() +
  scale_color_brewer(type = "qual", palette = 1) +
  theme(
    legend.position = "bottom",
    panel.spacing.y = unit(10, "mm")
  )

```


## Session info {.appendix}

<details><summary>Click for session info</summary>
```{r, R.options = list(width = 83)}
sessioninfo::session_info()
```
</details>
